import React, { useEffect, useMemo, useState, useCallback, useRef } from 'react';

const LS_KEY = 'uiSandbox18_v1'; // ‚úÖ ÎÑ§Í∞Ä Ïì∞Îçò v1 Î∞©Ïãù Í∑∏ÎåÄÎ°ú

// ---------- Util ----------
const pad2 = (n) => String(n).padStart(2, '0');
const todayStr = () => {
  const d = new Date();
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
};
const signLabel = (n) => (n > 0 ? `+${n}` : `${n}`);
const clamp = (v, min=null, max=null) => {
  let x = v;
  if (min != null) x = Math.max(min, x);
  if (max != null) x = Math.min(max, x);
  return x;
};

// ---------- Data ----------
function createInitialHoles() {
  return Array.from({ length: 18 }, (_, i) => ({
    hole_number: i + 1,
    par: 4,
    score: 0, putts: 2, penalties: 0,
    fir: null, gir: null,
    notes: '', shots: []
  }));
}

const COURSE_PRESETS = {
  'ÏïÑÏãúÏïÑÎÇòCC': [4,5,4,3,4,3,5,3,4, 4,4,5,3,4,4,5,3,4],
};

// ---------- iOS Îã®ÏùºÌÉ≠: ÌÑ∞Ïπò 1Î≤à = 1Ìöå Î∞òÏùë ----------
function useSingleTap(onTap) {
  const touchedRef = useRef(false);
  const onTouchStart = useCallback(() => { touchedRef.current = true; }, []);
  const onTouchEnd = useCallback((e) => {
    e.preventDefault(); // iOSÏóêÏÑú click Ï§ëÎ≥µ Î∞©ÏßÄ
    onTap && onTap();
    setTimeout(() => { touchedRef.current = false; }, 80);
  }, [onTap]);
  const onClick = useCallback((e) => {
    if (touchedRef.current) { e.preventDefault(); return; }
    onTap && onTap();
  }, [onTap]);
  return { onTouchStart, onTouchEnd, onClick };
}
function TapButton({ className='', onTap, children, ...rest }) {
  const handlers = useSingleTap(onTap);
  return <button type="button" className={className} {...handlers} {...rest}>{children}</button>;
}

// ---------- Shot Editor (compact) ----------
function ShotEditor({ shot, onChange, onRemove }) {
  return (
    <div className="ui-card shot-item">
      <div className="shot-row">
        <input placeholder="ÌÅ¥ÎüΩ" value={shot.club||''} onChange={e=>onChange('club',e.target.value)} />
        <input placeholder="ÏÉÅÌÉú(ÌéòÏñ¥Ïõ®Ïù¥/Îü¨ÌîÑ/Î≤ôÏª§)" value={shot.condition||''} onChange={e=>onChange('condition',e.target.value)} />
      </div>
      <div className="shot-row">
        <input placeholder="ÎÇ®ÏùÄÍ±∞Î¶¨(m)" inputMode="numeric" value={shot.remaining_dist??''} onChange={e=>onChange('remaining_dist', e.target.value===''?'':Number(e.target.value))} />
        <input placeholder="Ïã§Ï†úÍ±∞Î¶¨(m)" inputMode="numeric" value={shot.actual_dist??''} onChange={e=>onChange('actual_dist', e.target.value===''?'':Number(e.target.value))} />
      </div>
      <div className="shot-row">
        <input placeholder="Í≤∞Í≥º(Í∑∏Î¶∞Ïö∞/Ìï¥Ï†ÄÎìú Îì±)" value={shot.result||''} onChange={e=>onChange('result',e.target.value)} />
        <input placeholder="Î©îÎ™®" value={shot.notes||''} onChange={e=>onChange('notes',e.target.value)} />
      </div>
      <div className="ui-actions">
        <TapButton className="ui-danger" onTap={onRemove}>ÏÉ∑ ÏÇ≠Ï†ú</TapButton>
      </div>
    </div>
  );
}

// ---------- Tri-state Toggle ----------
function TriToggle({ label, value, onChange }) {
  return (
    <div className="ui-row">
      <div className="ui-label">{label}</div>
      <div className="ui-toggle">
        <TapButton className={`ui-pill ${value===true?'active':''}`} onTap={()=>onChange(true)}>YES</TapButton>
        <TapButton className={`ui-pill ${value===false?'active':''}`} onTap={()=>onChange(false)}>NO</TapButton>
        <TapButton className={`ui-pill ${value===null?'active':''}`} onTap={()=>onChange(null)}>‚Ä¢</TapButton>
      </div>
    </div>
  );
}

// ---------- Hole Card (compact) ----------
function HoleUnit({ hole, onChange }) {
  const h = hole || {};
  const set = (k,v)=>onChange({ ...h, [k]: v });

  const [openNotes, setOpenNotes] = useState(false);
  const [openShots, setOpenShots] = useState(false);

  const addShot = () => set('shots',[...(h.shots||[]),{club:'',condition:'',remaining_dist:'',actual_dist:'',result:'',notes:''}]);
  const updateShot = (i,k,v)=>{ const arr=[...(h.shots||[])]; arr[i]={...arr[i],[k]:v}; set('shots',arr); };
  const removeShot = (i)=>{ const arr=[...(h.shots||[])]; arr.splice(i,1); set('shots',arr); };

  return (
    <div className="ui-card">
      <div className="hole-header sticky-top">
        <div className="hole-title">üï≥Ô∏è {h.hole_number}H</div>
        <div className="hole-par">
          <span>Par</span>
          <input style={{maxWidth:70}} inputMode="numeric" value={h.par??4} onChange={e=>set('par', e.target.value===''?'':Number(e.target.value))}/>
        </div>
      </div>

      <div className="kv">
        <div className="kv-item"><div className="kv-t">Ïä§ÏΩîÏñ¥</div><div className="kv-v">{signLabel(h.score??0)}</div></div>
        <div className="kv-item"><div className="kv-t">ÌçºÌåÖ</div><div className="kv-v">{h.putts??0}</div></div>
        <div className="kv-item"><div className="kv-t">FIR</div><div className="kv-v">{h.fir==null?'‚Äî':h.fir?'YES':'NO'}</div></div>
        <div className="kv-item"><div className="kv-t">GIR</div><div className="kv-v">{h.gir==null?'‚Äî':h.gir?'YES':'NO'}</div></div>
      </div>

      <TriToggle label="FIR" value={h.fir} onChange={(v)=>set('fir',v)} />
      <TriToggle label="GIR" value={h.gir} onChange={(v)=>set('gir',v)} />

      {/* Ï†ëÌûò: ÎÖ∏Ìä∏ */}
      <div className="collapser">
        <TapButton className="collapse-head" onTap={()=>setOpenNotes(v=>!v)}>ÎÖ∏Ìä∏ {openNotes?'‚ñæ':'‚ñ∏'}</TapButton>
        {openNotes && (
          <div className="collapse-body">
            <textarea className="ui-textarea" placeholder="ÏΩîÏä§ Î©îÎ™®, Î∞îÎûå, ÎùºÏù¥ Îì±" value={h.notes||''} onChange={e=>set('notes',e.target.value)} />
          </div>
        )}
      </div>

      {/* Ï†ëÌûò: ÏÉ∑ */}
      <div className="collapser">
        <TapButton className="collapse-head" onTap={()=>setOpenShots(v=>!v)}>ÏÉ∑ {openShots?'‚ñæ':'‚ñ∏'}</TapButton>
        {openShots && (
          <div className="collapse-body">
            {(h.shots||[]).map((s,i)=>(
              <ShotEditor key={i} shot={s} onChange={(k,v)=>updateShot(i,k,v)} onRemove={()=>removeShot(i)} />
            ))}
            <div className="ui-actions">
              <TapButton className="ui-secondary" onTap={addShot}>ÏÉ∑ Ï∂îÍ∞Ä</TapButton>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

// ---------- Page (iPhone 14 Pro, 393px, no horizontal scroll) ----------
export default function UISandbox() {
  const styles = `
  :root { --pad:14px; --radius:12px; --safe-bottom: env(safe-area-inset-bottom); }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  html, body, #root { height:100%; }
  html, body { overflow-x:hidden; } /* Ï¢åÏö∞ Ïä§ÌÅ¨Î°§ Î∞©ÏßÄ */
  body { background:#f5f6fa; font-size:16px; }

  .wrap {
    min-height: 100dvh;
    padding: var(--pad);
    padding-bottom: calc(84px + var(--safe-bottom));
    margin: 0 auto;
    max-width: 393px; /* iPhone 14 Pro Ìè≠Ïóê ÎßûÏ∂§ */
  }

  h1 { font-size:18px; font-weight:800; margin: 0 0 4px; }
  .sub { color:#666; font-size:12px; margin-bottom:8px; display:flex; gap:6px; align-items:center; }

  .ui-card { background:#fff; border:1px solid #eee; border-radius: var(--radius); padding: 10px; box-shadow:0 1px 5px rgba(0,0,0,.04); }
  .stack { display:grid; gap:8px; }

  .ui-row { display:flex; align-items:center; justify-content:space-between; margin:8px 0; gap:8px; }
  .ui-label { font-weight:800; font-size:13px; white-space:nowrap; }
  .ui-toggle { display:flex; gap:6px; flex-wrap:wrap; }
  .ui-pill { padding:8px 12px; border-radius:999px; border:1px solid #ddd; background:#fff; font-weight:800; }
  .ui-pill.active { border-color:#0ea5e9; box-shadow:0 0 0 2px rgba(14,165,233,.15); }

  .ui-text { width:100%; height:42px; border:1px solid #ddd; border-radius:10px; padding:8px; font-size:16px; }
  .ui-textarea { width:100%; min-height:68px; border:1px solid #ddd; border-radius:10px; padding:8px; font-size:16px; }

  .ui-actions { display:flex; gap:6px; flex-wrap:wrap; }
  .ui-primary { background:#0ea5e9; color:#fff; border:none; padding:10px 12px; border-radius:10px; font-weight:900; }
  .ui-secondary { background:#f3f4f6; color:#111; border:none; padding:10px 12px; border-radius:10px; font-weight:800; }
  .ui-danger { background:#ef4444; color:#fff; border:none; padding:10px 12px; border-radius:10px; font-weight:900; }

  .top-row { display:grid; gap:8px; grid-template-columns: 1fr; }
  .grid2 { display:grid; gap:8px; grid-template-columns: 1fr 1fr; }

  /* 6√ó3 ÌôÄ Í∑∏Î¶¨Îìú (Í∞ÄÎ°ú Ïä§ÌÅ¨Î°§ ÏóÜÏùå) */
  .hole-grid { display:grid; grid-template-columns: repeat(6, 1fr); gap:6px; }
  .hole-pill { padding:6px 0; border:1px solid #ddd; border-radius:999px; background:#fff; font-weight:900; text-align:center; }
  .hole-pill.active { background:#0ea5e9; color:#fff; border-color:#0ea5e9; }
  .hole-pill.done { border-color:#16a34a; }

  .sticky-top { position: sticky; top: -4px; background:#fff; z-index: 2; padding-bottom: 4px; margin-bottom: 4px; }
  .hole-header { display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .hole-title { font-size:15px; font-weight:900; }
  .hole-par { display:flex; align-items:center; gap:6px; }
  .hole-par input { height:38px; border:1px solid #ddd; border-radius:10px; padding:8px; font-size:16px; width:70px; }

  /* ÌïµÏã¨ Í∞í */
  .kv { display:grid; grid-template-columns: repeat(4, 1fr); gap:6px; margin:4px 0 6px; }
  .kv-item { background:#f9fafb; border:1px solid #eee; border-radius:10px; padding:6px; text-align:center; }
  .kv-t { font-size:11px; color:#666; }
  .kv-v { font-size:16px; font-weight:900; margin-top:2px; }

  /* Ï†ëÌûò ÏÑπÏÖò */
  .collapser { margin-top:6px; }
  .collapse-head { width:100%; text-align:left; background:#f3f4f6; border:none; border-radius:10px; padding:8px 10px; font-weight:900; }
  .collapse-body { padding-top:6px; }

  /* ÌïòÎã® ÌÄµÌå®Îìú: 4Ïó¥√ó2Ìñâ */
  .quickpad {
    position: fixed; left: 0; right: 0; bottom: 0;
    padding: 8px 10px calc(8px + var(--safe-bottom));
    background: rgba(255,255,255,.96);
    backdrop-filter: saturate(180%) blur(6px);
    border-top: 1px solid #e5e7eb;
  }
  .qp { max-width: 393px; margin:0 auto; display:grid; gap:6px; }
  .qp-row { display:grid; grid-template-columns: repeat(4, 1fr); gap:6px; }
  .qp-big { height:44px; font-size:18px; border-radius:10px; border:1px solid #ddd; background:#fff; font-weight:900; }
  .qp-pill { height:44px; border-radius:999px; border:1px solid #ddd; background:#fff; font-weight:900; }
  .qp-pill.active { border-color:#0ea5e9; box-shadow:0 0 0 2px rgba(14,165,233,.15); }
  .qp-primary { height:44px; border:none; border-radius:10px; background:#0ea5e9; color:#fff; font-weight:900; }
  .qp-ghost { height:44px; border-radius:10px; border:1px dashed #ddd; display:grid; place-items:center; font-weight:800; }

  .summary { display:grid; grid-template-columns: repeat(4, 1fr); gap:6px; }
  .summary .box { background:#fff; border:1px solid #eee; border-radius:10px; padding:8px; text-align:center; }
  .summary .t { font-size:11px; color:#666; }
  .summary .v { font-size:16px; font-weight:900; margin-top:2px; }
  `;

  // ---------- State (v1 Î∞©Ïãù) ----------
  const [date, setDate] = useState(todayStr);
  const [course, setCourse] = useState('ÏïÑÏãúÏïÑÎÇòCC');
  const [holes, setHoles] = useState(createInitialHoles);
  const [active, setActive] = useState(0);
  const [savedAt, setSavedAt] = useState(null);
  const hasAppliedPresetRef = useRef(false);

  // Ï¥àÍ∏∞ Î≥µÍµ¨ (v1)
  useEffect(() => {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return;
    try {
      const parsed = JSON.parse(raw);
      if (parsed?.holes?.length === 18) setHoles(parsed.holes);
      if (parsed?.course) setCourse(parsed.course);
      if (parsed?.date) setDate(parsed.date);
    } catch(e) {/* ignore */}
  }, []);

  // Ï¶âÏãú Ï†ÄÏû• (v1)
  const persist = useCallback((nextHoles = holes, nextDate = date, nextCourse = course) => {
    localStorage.setItem(LS_KEY, JSON.stringify({ date: nextDate, course: nextCourse, holes: nextHoles }));
    setSavedAt(new Date());
  }, [holes, date, course]);

  const updateHole = (idx, next) => {
    const copy = [...holes];
    copy[idx] = next;
    setHoles(copy);
    persist(copy);
  };
  const updateDate = (v) => { setDate(v); persist(holes, v, course); };
  const updateCourse = (v) => { setCourse(v); persist(holes, date, v); };

  useEffect(() => {
    const handler = () => persist();
    window.addEventListener('beforeunload', handler);
    return () => window.removeEventListener('beforeunload', handler);
  }, [persist]);

  // ÏïÑÏãúÏïÑÎÇò PAR ÏûêÎèô/ÏàòÎèô Ï†ÅÏö© (ÎîîÏûêÏù∏ Ïú†ÏßÄ)
  const applyParPreset = useCallback((name) => {
    const arr = COURSE_PRESETS[name];
    if (!arr || arr.length !== 18) return false;
    const next = holes.map((h,i)=>({ ...h, par: Number(arr[i]) }));
    setHoles(next);
    persist(next, date, course);
    setSavedAt(new Date());
    return true;
  }, [holes, persist, date, course]);

  useEffect(() => {
    if (hasAppliedPresetRef.current) return;
    if (course === 'ÏïÑÏãúÏïÑÎÇòCC') {
      const allDefault = holes.every(h => h.par==null || Number(h.par)===4);
      if (allDefault) {
        if (applyParPreset('ÏïÑÏãúÏïÑÎÇòCC')) hasAppliedPresetRef.current = true;
      }
    }
  }, [course, holes, applyParPreset]);

  // Summary
  const summary = useMemo(() => {
    const totalRel = holes.reduce((s,h)=>s+(Number(h.score)||0),0);
    const totalPutts = holes.reduce((s,h)=>s+(Number(h.putts)||0),0);
    const firCount = holes.filter(h=>h.fir===true).length;
    const firValid = holes.filter(h=>h.fir!==null).length;
    const girCount = holes.filter(h=>h.gir===true).length;
    const girValid = holes.filter(h=>h.gir!==null).length;
    const firPct = firValid ? Math.round((firCount/firValid)*100) : null;
    const girPct = girValid ? Math.round((girCount/girValid)*100) : null;
    return { totalRel, totalPutts, firPct, girPct };
  }, [holes]);

  // Actions
  const resetAll = () => {
    if (!window.confirm('Î™®Îì† ÏûÖÎ†•ÏùÑ Ï¥àÍ∏∞ÌôîÌï†ÍπåÏöî?')) return;
    const init = createInitialHoles();
    const d = todayStr();
    setHoles(init);
    setCourse('ÏïÑÏãúÏïÑÎÇòCC');
    setDate(d);
    persist(init, d, 'ÏïÑÏãúÏïÑÎÇòCC');
    hasAppliedPresetRef.current = false;
  };
  const copyJSON = async () => {
    const payload = { date, course, holes };
    try { await navigator.clipboard.writeText(JSON.stringify(payload, null, 2)); alert('JSON Î≥µÏÇ¨ ÏôÑÎ£å!'); }
    catch { alert('Î≥µÏÇ¨ Ïã§Ìå®. ÎÇ¥Î≥¥ÎÇ¥Í∏∞Î•º ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî.'); }
  };
  const exportJSON = () => {
    const payload = { date, course, holes };
    const blob = new Blob([JSON.stringify(payload,null,2)], { type:'application/json' });
    const url = URL.createObjectURL(blob); const a = document.createElement('a');
    a.href = url; a.download = `golf-round-${course}-${date}.json`; a.click(); URL.revokeObjectURL(url);
  };
  const shareJSON = async () => {
    try {
      const payload = { date, course, holes };
      const file = new File([JSON.stringify(payload,null,2)], `golf-round-${course}-${date}.json`, { type:'application/json' });
      if (navigator.share && navigator.canShare && navigator.canShare({ files:[file] })) {
        await navigator.share({ title:'Golf Round', text:`${course} ${date}`, files:[file] });
      } else { exportJSON(); }
    } catch {}
  };

  // Hole change & keypad
  const gotoPrev = () => setActive(a=>Math.max(0,a-1));
  const gotoNext = () => setActive(a=>Math.min(17,a+1));
  const bumpScore = (d) => { const h=holes[active]; updateHole(active,{...h, score: clamp((h.score??0)+d,-5,10)}); };
  const bumpPutts = (d) => { const h=holes[active]; updateHole(active,{...h, putts: clamp((h.putts??0)+d,0,10)}); };
  const cycleFIR = () => { const h=holes[active]; const next=h.fir===null?true:h.fir===true?false:null; updateHole(active,{...h,fir:next}); };
  const cycleGIR = () => { const h=holes[active]; const next=h.gir===null?true:h.gir===true?false:null; updateHole(active,{...h,gir:next}); };

  const activeHole = holes[active];
  const isDone = (h)=> (h.putts??0)>0 || h.fir!=null || h.gir!=null || (h.score??0)!==0;

  return (
    <div className="wrap">
      <style>{styles}</style>

      <h1>‚õ≥ ÎùºÏö¥Îìú ÏûÖÎ†• (iPhone 14 Pro)</h1>
      <div className="sub">
        <span>{savedAt ? `Ï†ÄÏû•Îê® ${savedAt.toLocaleTimeString()}` : 'ÏûÖÎ†• Ï¶âÏãú Ï†ÄÏû•'}</span>
      </div>

      <div className="stack" style={{marginBottom:6}}>
        <div className="ui-card">
          <div className="top-row">
            <div className="grid2">
              <div>
                <div className="ui-label">ÎÇ†Ïßú</div>
                <input type="date" className="ui-text" value={date} onChange={e=>updateDate(e.target.value)} />
              </div>
              <div>
                <div className="ui-label">ÏΩîÏä§</div>
                <input className="ui-text" value={course} onChange={e=>updateCourse(e.target.value)} placeholder="ÏΩîÏä§Î™Ö ÏûÖÎ†•" />
              </div>
            </div>

            <div className="summary">
              <div className="box"><div className="t">Ïä§ÏΩîÏñ¥</div><div className="v">{signLabel(summary.totalRel)}</div></div>
              <div className="box"><div className="t">ÌçºÌåÖ Ìï©</div><div className="v">{summary.totalPutts}</div></div>
              <div className="box"><div className="t">FIR</div><div className="v">{summary.firPct==null?'‚Äî':`${summary.firPct}%`}</div></div>
              <div className="box"><div className="t">GIR</div><div className="v">{summary.girPct==null?'‚Äî':`${summary.girPct}%`}</div></div>
            </div>

            <div className="ui-actions">
              <TapButton className="ui-secondary" onTap={()=>applyParPreset(course)}>ÏΩîÏä§ Ìåå Î∂àÎü¨Ïò§Í∏∞</TapButton>
              <TapButton className="ui-primary" onTap={shareJSON}>Í≥µÏú†/ÎÇ¥Î≥¥ÎÇ¥Í∏∞</TapButton>
              <TapButton className="ui-secondary" onTap={copyJSON}>JSON Î≥µÏÇ¨</TapButton>
              <TapButton className="ui-danger" onTap={resetAll}>Ï¥àÍ∏∞Ìôî</TapButton>
            </div>
          </div>

          {/* 6√ó3 Ï†ÑÏ≤¥ ÌôÄ Í∑∏Î¶¨Îìú (Í∞ÄÎ°ú Ïä§ÌÅ¨Î°§ ÏóÜÏùå) */}
          <div className="ui-card" style={{marginTop:6}}>
            <div className="hole-grid">
              {holes.map((h,i)=>(
                <TapButton
                  key={i}
                  className={`hole-pill ${i===active?'active':''} ${isDone(h)?'done':''}`}
                  onTap={()=>setActive(i)}
                >
                  {h.hole_number}
                </TapButton>
              ))}
            </div>
          </div>
        </div>

        {/* ÌôúÏÑ± ÌôÄ */}
        <HoleUnit hole={activeHole} onChange={(n)=>updateHole(active, n)} />
      </div>

      {/* ÌïòÎã® ÌÄµÌå®Îìú: 4Ïó¥√ó2Ìñâ */}
      <div className="quickpad">
        <div className="qp">
          <div className="qp-row">
            <TapButton className="qp-big" onTap={()=>bumpScore(-1)}>‚àí Ïä§ÏΩîÏñ¥</TapButton>
            <TapButton className={`qp-pill ${activeHole.fir?'active':''}`} onTap={cycleFIR}>
              {activeHole.fir===null?'FIR ‚Ä¢':activeHole.fir?'FIR ‚úì':'FIR ‚úó'}
            </TapButton>
            <TapButton className={`qp-pill ${activeHole.gir?'active':''}`} onTap={cycleGIR}>
              {activeHole.gir===null?'GIR ‚Ä¢':activeHole.gir?'GIR ‚úì':'GIR ‚úó'}
            </TapButton>
            <TapButton className="qp-big" onTap={()=>bumpScore(+1)}>Ôºã Ïä§ÏΩîÏñ¥</TapButton>
          </div>
          <div className="qp-row">
            <TapButton className="qp-big" onTap={()=>bumpPutts(-1)}>‚àí ÌçºÌåÖ</TapButton>
            <TapButton className="qp-primary" onTap={gotoPrev}>‚óÄ Ïù¥Ï†Ñ</TapButton>
            <TapButton className="qp-primary" onTap={gotoNext}>Îã§Ïùå ‚ñ∂</TapButton>
            <TapButton className="qp-big" onTap={()=>bumpPutts(+1)}>Ôºã ÌçºÌåÖ</TapButton>
          </div>
        </div>
      </div>
    </div>
  );
}
